#!/bin/bash
if [ $# -eq 0 ]; then
  echo "
    Run a pviz python script on a list of files.
    usage:
      pviz_postPy   ncpus pyFile    *.xmf

    for instance:
      pviz_postPy   48 $PVIZ/examples/simple/cut_z0.py *.xmf
    exiting ..."
  exit
fi

ncpus=$1
pyFile=$2 # full path to paraview batch script
shift 2 # Remove ncpus and pyFile from $@

# If MAC OS X, use graphics card (offscreen-rendering doesnt work well on mac)
if [ "`uname`" == Darwin ]; then offscreen=""
else                             offscreen="--use-offscreen-rendering"
fi

if [ $ncpus -eq 1 ]; then pvbatch="pvbatch"
else                      pvbatch="mpirun -np $ncpus pvbatch"
fi

for solution in $@; do
  $pvbatch $offscreen $pyFile -s $solution
done

myBaseName=`basename $pyFile`
myBaseNameWoExt=${myBaseName%.py}
# If png images are present in the directory, it's assumed that they
# have been generated by the present pviz script.
# Move all pngs into PNGS_$myBaseNameWoExt
if ls -U *.png 1> /dev/null 2>&1; then
  outName=PNGS_${myBaseNameWoExt}
  mkdir -p $outName
  mv *.png $outName
  echo "Moved snapshot into $outName"
fi
